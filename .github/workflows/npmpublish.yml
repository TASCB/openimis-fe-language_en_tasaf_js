# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: Publish Node.js Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node version to use'
        required: true
        default: '20'
      registry_url:
        description: 'NPM registry URL'
        required: true
        default: 'https://registry.npmjs.org/'
      scope:
        description: 'Scope for npm package'
        required: false
        default: 'openimis'
      access:
        description: 'Access level for npm package'
        required: false
        default: 'public'
      tag:
        description: 'Dist-tag (latest, next, beta...)'
        required: true
        default: 'latest'

jobs:
  npmjs:
    uses: openimis/openimis-fe_js/.github/workflows/module-npmpublish.yml@develop
    with:
      registry_url: ${{ inputs.registry_url || 'https://registry.npmjs.org/' }}
      node_version: ${{ inputs.node_version || '20' }}
      scope:        ${{ inputs.scope        || 'openimis' }}
      access:       ${{ inputs.access       || 'public' }}
      tag:          ${{ inputs.tag          || 'latest' }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  gpr:
    needs: npmjs
    uses: openimis/openimis-fe_js/.github/workflows/module-npmpublish.yml@develop
    with:
      registry_url: 'https://npm.pkg.github.com/'
      node_version: ${{ inputs.node_version || '20' }}
      scope:        ${{ inputs.scope        || 'openimis' }}
      access:       ${{ inputs.access       || 'public' }}
      tag:          ${{ inputs.tag          || 'latest' }}
    secrets:
      NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
